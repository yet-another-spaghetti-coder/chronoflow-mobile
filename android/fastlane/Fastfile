default_platform(:android)

platform :android do
  desc "Deploy a new version to the Google Play Internal Track"
  lane :deploy do
    # 1. Define a temporary path for the keystore
    keystore_path = "/tmp/upload_keystore.jks"

    # 2. Decode the Keystore
    if ENV['ANDROID_KEYSTORE_BASE64'].to_s.empty?
      UI.user_error!("ENV['ANDROID_KEYSTORE_BASE64'] is missing!")
    end
    
    File.open(keystore_path, 'wb') do |f|
      f.write(Base64.decode64(ENV['ANDROID_KEYSTORE_BASE64']))
    end
    File.chmod(0600, keystore_path)

    # 3. Build App Bundle (AAB)
    gradle(
      task: "clean bundleRelease",
      properties: {
        "android.injected.signing.store.file" => keystore_path,
        "android.injected.signing.store.password" => ENV['STORE_PASSWORD'],
        "android.injected.signing.key.alias" => ENV['KEY_ALIAS'],
        "android.injected.signing.key.password" => ENV['KEY_PASSWORD']
      }
    )

    # 4. Upload to Play Store (Internal Track)
    upload_to_play_store(
      track: "internal",
      release_status: "draft",
      json_key_data: ENV['PLAY_STORE_SA_JSON'],
      skip_upload_apk: true
    )

    # 5. Cleanup
    File.delete(keystore_path) if File.exist?(keystore_path)
  end
end