name: PR Checks
on:
  pull_request:
    branches: [main, dev]
    paths-ignore: ["**.md", "docs/**"]
permissions:
  contents: read
  security-events: write
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze-and-test:
    runs-on: [self-hosted, Linux, ARM64]
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.38.9
          cache: true
      - name: Generate Dummy Firebase Options
        run: |
          mkdir -p lib
          cat <<EOF > lib/firebase_options.dart
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show TargetPlatform, defaultTargetPlatform, kIsWeb;
          
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) {
                return const FirebaseOptions(
                  apiKey: 'fake-api-key',
                  appId: 'fake-app-id',
                  messagingSenderId: 'fake-sender-id',
                  projectId: 'fake-project-id',
                );
              }
              switch (defaultTargetPlatform) {
                case TargetPlatform.android:
                  return const FirebaseOptions(
                    apiKey: 'fake-api-key',
                    appId: 'fake-app-id',
                    messagingSenderId: 'fake-sender-id',
                    projectId: 'fake-project-id',
                    storageBucket: 'fake-bucket',
                  );
                case TargetPlatform.iOS:
                  return const FirebaseOptions(
                    apiKey: 'fake-api-key',
                    appId: 'fake-app-id',
                    messagingSenderId: 'fake-sender-id',
                    projectId: 'fake-project-id',
                    storageBucket: 'fake-bucket',
                    iosBundleId: 'com.example.app',
                  );
                case TargetPlatform.macOS:
                  return const FirebaseOptions(
                    apiKey: 'fake-api-key',
                    appId: 'fake-app-id',
                    messagingSenderId: 'fake-sender-id',
                    projectId: 'fake-project-id',
                    storageBucket: 'fake-bucket',
                    iosBundleId: 'com.example.app',
                  );
                case TargetPlatform.windows:
                  return const FirebaseOptions(
                    apiKey: 'fake-api-key',
                    appId: 'fake-app-id',
                    messagingSenderId: 'fake-sender-id',
                    projectId: 'fake-project-id',
                    authDomain: 'fake-auth-domain',
                    storageBucket: 'fake-bucket',
                  );
                case TargetPlatform.linux:
                  return const FirebaseOptions(
                    apiKey: 'fake-api-key',
                    appId: 'fake-app-id',
                    messagingSenderId: 'fake-sender-id',
                    projectId: 'fake-project-id',
                    authDomain: 'fake-auth-domain',
                    storageBucket: 'fake-bucket',
                  );
                case TargetPlatform.fuchsia:
                  throw UnsupportedError(
                    'DefaultFirebaseOptions are not supported for this platform.',
                  );
              }
            }
          }
          EOF
      - run: flutter pub get
      - run: |
          dart format --set-exit-if-changed \
          $(find lib test -name "*.dart" \
            -not -name "firebase_options.dart")
      - run: flutter analyze --fatal-infos
      - run: flutter test --coverage --concurrency=4
      - uses: codecov/codecov-action@v5
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  security-scan:
    runs-on: [self-hosted, Linux, ARM64]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - uses: MobSF/mobsfscan@0.4.5
        with:
          args: ". --sarif --output results.sarif || true"
      - name: Upload mobsfscan report
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
          category: mobsfscan
